%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  Copyright by Wenliang Du.                                       %%
%%  This work is licensed under the Creative Commons                %%
%%  Attribution-NonCommercial-ShareAlike 4.0 International License. %%
%%  To view a copy of this license, visit                           %%
%%  http://creativecommons.org/licenses/by-nc-sa/4.0/.              %%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\commonfolder}{../../common-files}

\input{\commonfolder/header}
\input{\commonfolder/copyright}

\newcommand{\firewallFigs}{./Figs}
\lhead{\bfseries SEED Labs -- Laboratorio de Evasión de Firewall}

\begin{document}



\begin{center}
{\LARGE Laboratorio de Evasión de Firewall: Bypasseando Firewalls usando VPN}
\end{center}


\seedlabcopyright{2018}

\newcounter{task}
\setcounter{task}{1}
\newcommand{\tasks} {\bf {\noindent (\arabic{task})} \addtocounter{task}{1} \,}


% *******************************************
% SECTION
% ******************************************* 
\section{Descripción}

Organizaiones, Internet Service Providers (ISPs) y paises a menudo bloquean el acceso a determinados sitios externos a sus usuarios internos. Esto es llamado filtrado de salida o egress filtering.
Por ejemplo, para prevenir distracción en horarios laborales, muchas companias configuran la salida de sus firewalls para bloquear sitios de redes sociales, por lo que sus empleados no podrán acceder a estos dentro de la red interna. Por razones políticas, muchos países configurar filtrados de salida en sus ISPs para bloquear a su gente el acceso a determinados sitios foráneos. Desafortunadamente, estos firewalls pueden ser fácilmente bypasseados y existen servicios/productos que ayudan a los usuarios bypassear estos firewalls, estas soluciones están a la alcance de todos. La tecnología más usada para bypassear estos filtrados de salida son las Virtual Private Network (VPN).
Esta tecnología es ampliamente usada por usuarios que poseen smartphones y que son afectados por este tipo de bloqueo; existen muchas aplicaciones VPN (para Android, iOs y otras plataformas) que ayudan a los usuarios a evadir estas reglas de filtrado que se aplican en los firewalls.

El objetivo de este laboratorio es que los estudiantes vean como funciona una VPN y como una VPN puede ayudar a bypassear los filtrados de salida de un firewall.
En este Laboratorio, implementaremos una VPN muy simple que usaremos para bypassear firewalls. Una VPN típica depende de dos piezas: IP tunneling y el cifrado. El tunneling es esencial ya que será quien nos ayude a byppasear firewalls; el cifrado es para proteger el contenido del tráficos que viaja a través del tunel de la VPN.
Por un tema de simplicidad, en este laboratorio solamente nos centramos en el tunneling, por lo que el tráfico dentro de nuestro tunel no estará cifrado. Tenemos otro laboratorio sobre VPN en donde cubrimos tunneling y cifrado. Si los lectores están interesados, pueden trabajar sobre este laboratorio para aprender como construir una VPN completa. En este Laboratorio solamente nos centramos en como usar un tunel VPN para bypassear firewalls.

Este laboratorio cubre los siguientes tópicos:

\begin{itemize}[noitemsep]
\item Firewall
\item VPN
\end{itemize}


\paragraph{Lectura y Videos.}
Para una cobertura más detallada sobre firewalls, técnicas de evasión y VPN puede consultar:

\begin{itemize}
\item Capítulos 17 y 19 del libro de SEED, \seedbook
\item Secciones 8 y 9 del curso de SEED en Udemy, \seedisvideo
\end{itemize}


\paragraph{Entorno de Laboratorio.} \seedenvironmentB
 


% *******************************************
% SECTION
% ******************************************* 
\section{Tareas del Laboratorio}




% -------------------------------------------
% SUBSECTION
% ------------------------------------------- 
\subsection{Tarea 1: Setup de la Máquina Virtual}

Necesitamos dos máquinas, una dentro del firewall y la otra fuera del firewall. El objetivo es ayudar a la máquina que se encuentra dentro del firewall que pueda visitar sitios bloqueados por el firewall.
Las máquinas que usaremos serán, VM1 y VM2, estas máquinas se suponen conectadas a internet a través de routers. Este setup puede requiera más de dos Máquinas Virtuales.
Para hacer todo más sencillo, usaremos una LAN para emular la conexión a Internet.
Básicamente, conectaremos VM1 y VM2 a la LAN usando un adaptor de \texttt{NAT Network}. 
La Figura describe el setup de nuestro laboratorio.


\begin{figure}[htb]
  \begin{center}
    \includegraphics[width=0.9\textwidth]{\firewallFigs/Host2Gateway.pdf}
  \end{center}
  \caption{Setup del Laboratorio}
  \label{vpn_firewall:fig:labsetup}
\end{figure}



% -------------------------------------------
% SUBSECTION
% ------------------------------------------- 
\subsection{Tarea 2: Setup del Firewall}

En esta tarea, ud. hara el setup del firewall en la VM1 para bloquear el acceso a un sitio web. Debe asegurarse que la dirección IP de este sitio web sea fija o este dentro de un rango fijo; de otra forma puede terminar bloqueando por completo el sitio web. Por favor vea el laboratorio de Firewall para detalles en como bloquear sitios web.

En el mundo real, un firewall debería de correr en una máquina separada, no en VM1. Para minimizar el números de VMs usadas en el laboratorio, pondremos el firewall en VM1. Configurar un firewall en VM1 requiere de privilegios de superusuario como así también lo requiere la configuración del tunel VPN. Uno podría decir si contamos con privilegios de superusuario, porque no podemos desactivar el firewall en VM1 y listo. Este es un buen argumento, pero tenga en cuenta, que estamos poniendo el firewall en VM1 porque no queremos crear otra VM en el entorno de laboratorio. Además, aunque cuente con privilegios de superusuario en VM1, no le es permitido usar ese privilegio para reconfigurar el firewall. Ud. deberá de usar una VPN para bypassearlo.

A diferencia de situar el firewall en una máquina externa, poner el firewall en VM1 tiene un pequeño inconveniente con el cual necesitamos convivir. Cuando hacemos el setup del firewall para bloquear paquetes, necesitamos asegurarnos de no bloquear los paquetes que vienen de la interfaz virtual usada por la VPN o nuestra VPN no será capaz de obtener los paquetes. Además, no podemos setear la regla del firewall antes del routing o setearla  en la interfaz virtual. Necesitamos setear la regla en la interfaz de red real de VM1, para no afectar a los paquetes que van hacia la interfaz virtual. El siguiente comando bloquea todo el tráfico hacia la red \texttt{93.184.216.0/24}  (\texttt{example.com}).


\begin{lstlisting}
$ sudo iptables -A OUTPUT -o enp0s3 -d 93.184.216.0/24 -j DROP
\end{lstlisting}

Por favor identifique el sitio web que quiere bloquear, haga el setup del firewall y demuestre que su firewall está funcionando y la dirección IP que esta bloqueando no se puede alcanzar. Provea capturas de pantalla en su informe del laboratorio.

% -------------------------------------------
% SUBSECTION
% ------------------------------------------- 
\subsection{Tarea 3: Bypasseando el Firewall usando VPN}

La idea de usar una VPN para bypassear un firewall es ilustrada en la Figura \ref{vpn_firewall:fig:bypassing}. 
Establecemos un tunel VPN entre VM1 (Cliente VPN) y VM2 (Servidor VPN).
Cuando un usuario trata de acceder al sitio bloqueado, el tráfico no viajará directo a través del adaptador de red, porque será bloqueado. En vez de esto, los paquetes que se dirigen al sitio bloqueado desde VM1 serán enrutados hacia el tunel VPN y llegarán a VM2. Una vez que estos llegan ahí, VM2 los enrutará hacia su destino final.
Cuando la respuestas de los paquetes lleguen de regreso, regresarán hacia VM2, que redireccionará los paquetes hacia el tunel VPN y eventualmente los paquetes volverán a VM1. Así es como una VPN ayuda a bypassear firewalls.

The idea of using VPN to bypass firewall is depicted in 
Figure~\ref{vpn_firewall:fig:bypassing}. 
We establish a VPN tunnel between VM1 (VPN Client VM) 
and VM2 (VPN Server VM). 
When a user on VM1 tries to access a blocked site, the traffic will not directly 
go through its network adapter, because it will be blocked. Instead, the 
packets to the blocked site from VM1 will be routed to the VPN tunnel and arrive at VM2. Once
they arrive there, VM2 will route them to the final destination. 
When the reply packets come back, it will come back to VM2, which will then redirect the
packets to the VPN tunnel, and eventually get the packet back to VM1. That is how the VPN helps
VM1 to bypass firewalls. 

\begin{figure}[htb]
\begin{center}
\includegraphics[width=1.0\textwidth]{\firewallFigs/BypassingFirewall.pdf}
\end{center}
\caption{Bypasseando Firewall usando una VPN}
\label{vpn_firewall:fig:bypassing}
\end{figure}
 
Hemos creado un programa VPN de ejemplo, incluídos un programa cliente (\texttt{vpnclient}) y un programa servidor (\texttt{vpnserver}), ambos pueden ser descargados del sitio oficial del laboratorio. Estos programas VPN son muy simples y solamente establecen un tunel VPN entre el cliente y el servidor; no cifra el tráfico del tunel.
El programa es explicado en detalle en el libro de SEED (Capítulo VPN).


\begin{figure}[htb]
\begin{center}
\includegraphics[width=0.9\textwidth]{\firewallFigs/ClientServerTunnel.pdf}
\end{center}
\caption{Cliente y Servidor VPN}
\label{vpn_firewall:fig:client_server}
\end{figure}

The \texttt{vpnclient} and \texttt{vpnserver} programs are the two ends of
a VPN tunnel. They communicate with each other using either TCP or UDP via the sockets
depicted in Figure~\ref{vpn_firewall:fig:client_server}. In our sample code, we choose
to use UDP for the sake of simplicity.  The dotted line between the
client and server depicts the path for the VPN tunnel.
The VPN client and server programs connect to the hosting system via a
TUN interface, through which they do two things: (1) get IP packets from
the hosting system, so the packets can be sent through the tunnel, (2) get IP packets from the
tunnel, and then forward it to the hosting system, which will forward the
packet to its final destination.
The following procedure describes how to create a VPN tunnel
using the \texttt{vpnclient} and \texttt{vpnserver} programs.


\paragraph{Paso 1: Iniciar el Servidor VPN.}
We first run the VPN server program \texttt{vpnserver} on the Server VM.
After the program runs, a virtual TUN network interface will appear
in the system (we can see it using the \texttt{"ifconfig -a"} command; the name of the
interface will be \texttt{tun0} in most cases, but they can be
\texttt{tunX}, where \texttt{X} is a number).
This new interface is not yet configured, so we need to configure it by giving it an IP
address. We use \texttt{192.168.53.1} for this interface, but you can use 
other IP addresses. 


Run the following commands. The first command will start the server
program, and the second command assigns an IP address to the \texttt{tun0}
interface and then activates it. It should be noted that the first
command will block and wait for connections,
so we need to find another window run the second command.


\begin{lstlisting}
$ sudo ./vpnserver

Run the following command in another window:
$ sudo ifconfig tun0 192.168.53.1/24 up
\end{lstlisting}

Unless specifically configured, a computer will only act as a host,
not as a gateway. The VPN Server needs to forward packets to other destinations,
so it needs to function as a gateway. We need to
enable the IP forwarding for a computer to behave like a gateway.
IP forwarding can be enabled
using the following command:

\begin{lstlisting}
$ sudo sysctl net.ipv4.ip_forward=1
\end{lstlisting}



\paragraph{Paso 2: Iniciar el Cliente VPN.} 
We now run the VPN client program on the Client
VM.  We run the following command on this machine (the first command
will connect to the VPN server program running on {\tt 10.0.2.8}.
This command will block as well, so we need to find another window to
configure the \texttt{tun0} interface created by the VPN client program.
We assign IP address \texttt{192.168.53.5} to the \texttt{tun0} interface~(you
can choose other IP addresses).


\begin{lstlisting}
On VPN Client VM:
$ sudo ./vpnclient 10.0.2.8

Run the following command in a different window
$ sudo ifconfig tun0 192.168.53.5/24 up
\end{lstlisting}



\paragraph{Step 3: Set Up Routing on Client and Server VMs.}
After the above two steps, the tunnel will be established.
Before we can use the tunnel, we need to set up routing
paths on both client and server machines to direct the intended traffic through
the tunnel. 
We can use the \texttt{route} command to add an routing entry. The
following example shows how to route the \texttt{10.20.30.0/24}-bound
packets to the interface \texttt{eth0}.

\begin{lstlisting}
$ sudo route add -net 10.20.30.0/24 eth0
\end{lstlisting}

To bypass firewalls on the Client VM, you need to set up 
routing entries accordingly, so the traffics to the blocked site
will be routed towards the VPN. You need to think about what 
routing entries to add in order to bypass the firewall. 



\paragraph{Paso 4: Setup del NAT en la Máquina Virtual del Servidor.}
When the final destination sends packets back to users, the packet
will be sent to the VPN Server first (think about why and write down your answer 
in the report). The return packet will reach the VPN Server's NAT
adapter first (because the source IPs of all  the outgoing
packets from the Server VM are changed to the NAT's external IP address (which is basically the host computer's IP
address in our setup). Usually, the NAT will replace the destination IP address with the IP
address of the original packet (i.e. \texttt{192.168.53.5} in our case), and give it back to whoever owns
the IP address.  Unfortunately, we have a problem here.


Before the NAT sends out the packet, it needs to know the MAC address of the machine who owns
\texttt{192.168.53.5}, so it sends an ARP request. Our private network is virtual, and 
this IP address belongs to the \texttt{tun0} interface on the VPN Client.  
therefore, \texttt{192.168.53.5} will not receive the ARP request (even if it does, it has no
use). The NAT will then drop the packet, because the recipient does not exist.


The actual recipient should be the VPN Server VM, even though it does not own 
\texttt{192.168.53.5}.  If
we can configure the NAT as a gateway, we can ask the NAT to route the packets for
\texttt{192.168.53.5} to 
the VPN Server, which will eventually deliver the packets through the tunnel to the VPN Client. However,
we have not figured out how to configure the NAT as a gateway in VirtualBox, we did
come up two work-around solutions. One idea is to ``fool'' the NAT to believe that the MAC address of
\texttt{192.168.53.5} is the VPN Server VM's MAC address, so the packet will be delivered to
the VPN Server by the NAT. We can achieve this using an ARP cache poisoning on the NAT, basically telling the
NAT before hand about the MAC address of \texttt{192.168.53.5}.

A better solution to get round the limitation of the NAT is to create another NAT
right on the Server VM, so all packets coming out of the Server VM will have this VM's IP address as their source IP.
To reach the Internet, these packets will go through another NAT, which is provided by
VirtualBox, but since the source IP is the Server VM, this second NAT will have no problem relaying back
the returned packets from the Internet to the Server VM. Using this solution, we do not need to use ARP
cache poisoning to ``fool'' the NAT any more. The following commands can enable the NAT on
the Server VM~(in your case, the name of the \texttt{NAT Network} adapter may not be called 
\texttt{enp0s3}; you just need to find its real name on your VM):

    
\begin{lstlisting}
$ sudo iptables -t nat -A POSTROUTING -j MASQUERADE -o enp0s3
\end{lstlisting}
    


\paragraph{Demostración.}
If you have done the steps above correctly, you should be able to bypass
the firewall. You should show that you can reach the blocked web site from Client VM
via the VPN.  Your solution should
not only work for web traffic, but also for all other traffic. For example, if the blocked
machine runs a \texttt{telnet} server, you should be able to \texttt{telnet} to this blocked server from
Client VM. 

In your lab report, you should provide the evidence to show that your traffic did go through
the VPN tunnel, not through some ``side doors''. The best way to show that is to capture the
network traffic using Wireshark, and describe the path of your packets using the captured
traffic. Without such an evidence, we have no idea whether your success is due to a
mis-configured firewall (i.e. the targeted web site is not blocked at all) or due to your VPN.



% *******************************************
% SECTION
% ******************************************* 
\section{Informe del Laboratorio}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{\commonfolder/submission}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Agradecimientos}

\input{\commonfolder/acknowledgments}

\end{document}


